name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Get version info
      id: version
      run: |
        $commitCount = git rev-list --count HEAD
        $shortSha = git rev-parse --short HEAD
        $version = "1.0.$commitCount"
        $tag = "v$version"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "sha=$shortSha" >> $env:GITHUB_OUTPUT
    
    - name: Publish Lite Edition (requires .NET 8 + Python)
      run: dotnet publish CS2KZMappingTools.csproj -c Release -p:PublishSingleFile=true -p:SelfContained=false -p:RuntimeIdentifier=win-x64 -p:EnableCompressionInSingleFile=false --no-restore -o publish/lite
    
    - name: Setup Python for Complete Edition
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Prepare Python Embedded Bundle
      run: |
        # Download embedded Python
        Write-Host "Downloading Python 3.11.8 embedded..."
        Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.8/python-3.11.8-embed-amd64.zip" -OutFile "python-embed.zip"
        
        # Extract to temp location
        Write-Host "Extracting Python..."
        New-Item -ItemType Directory -Force -Path "python-temp"
        Expand-Archive -Path "python-embed.zip" -DestinationPath "python-temp" -Force
        
        # Enable site-packages
        $pthFile = "python-temp/python311._pth"
        if (Test-Path $pthFile) {
            Write-Host "Configuring Python paths..."
            $content = Get-Content $pthFile
            $content = $content -replace '#import site', 'import site'
            $content += "`nLib"
            $content += "`nLib/site-packages"
            Set-Content -Path $pthFile -Value $content
        }
        
        # Download and install pip
        Write-Host "Installing pip..."
        Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "python-temp/get-pip.py"
        & "python-temp/python.exe" "python-temp/get-pip.py" --no-warn-script-location
        
        # Install required packages
        Write-Host "Installing Python dependencies..."
        & "python-temp/python.exe" -m pip install -r requirements.txt --target "python-temp/Lib/site-packages" --no-warn-script-location
        
        # Clean up unnecessary files to reduce size
        Write-Host "Cleaning up..."
        Remove-Item -Path "python-temp/get-pip.py" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "python-temp/Lib/site-packages/pip*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "python-temp/Lib/site-packages/setuptools*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "python-temp/Lib/site-packages/*.dist-info" -Recurse -Force -ErrorAction SilentlyContinue
        
        # Create python-embed directory in project root for embedding
        New-Item -ItemType Directory -Force -Path "python-embed"
        Copy-Item -Path "python-temp/*" -Destination "python-embed/" -Recurse -Force
        
        Write-Host "Python bundle prepared successfully"
    
    - name: Publish Complete Edition (with .NET + Python embedded)
      run: |
        Write-Host "Building Complete Edition with embedded .NET Runtime + Python..."
        dotnet publish CS2KZMappingTools.csproj -c Release -p:PublishSingleFile=true -p:SelfContained=true -p:RuntimeIdentifier=win-x64 -p:IncludeNativeLibrariesForSelfExtract=true -p:EnableCompressionInSingleFile=true --no-restore -o publish/complete
        Write-Host "Complete Edition built successfully"
    
    - name: Rename Artifacts
      run: |
        Rename-Item -Path "publish/lite/CS2KZMappingTools.exe" -NewName "jakkes-tools-Lite.exe"
        Rename-Item -Path "publish/complete/CS2KZMappingTools.exe" -NewName "jakkes-tools-Complete.exe"
        Write-Host "Lite Edition: $('{0:N2}' -f ((Get-Item 'publish/lite/jakkes-tools-Lite.exe').Length / 1MB)) MB"
        Write-Host "Complete Edition: $('{0:N2}' -f ((Get-Item 'publish/complete/jakkes-tools-Complete.exe').Length / 1MB)) MB"
    
    - name: Upload Lite Edition Artifact
      uses: actions/upload-artifact@v4
      with:
        name: jakkes-tools-Lite
        path: publish/lite/jakkes-tools-Lite.exe
    
    - name: Upload Complete Edition Artifact
      uses: actions/upload-artifact@v4
      with:
        name: jakkes-tools-Complete
        path: publish/complete/jakkes-tools-Complete.exe
    
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        body: |
          ## Automated Release
          Build ${{ steps.version.outputs.version }} from commit ${{ steps.version.outputs.sha }}
          
          ---
          
          ## üì• Downloads
          
          ### jakkes-tools-Complete.exe ‚≠ê **Recommended**
          - ‚úÖ **Fully portable** - No installation needed
          - ‚úÖ Includes .NET 8 Runtime
          - ‚úÖ Includes Python 3.11 embedded
          - ‚úÖ All dependencies included
          - üöÄ Just download and run!
          
          ### jakkes-tools-Lite.exe
          - ‚ö†Ô∏è Requires .NET 8 Desktop Runtime ([Download](https://dotnet.microsoft.com/download/dotnet/8.0))
          - ‚ö†Ô∏è Requires Python 3.11+ installed
          - üíæ Smallest download size
          
          ---
          
          ## üìù Changes
          ${{ github.event.head_commit.message }}
        files: |
          publish/complete/jakkes-tools-Complete.exe
          publish/lite/jakkes-tools-Lite.exe
          jakkes-tools-Complete.zip
          publish/lite